-- DROP USER "C##MAASHESAPLA";

CREATE USER "C##MAASHESAPLA"
-- IDENTIFIED BY <password>
;

CREATE TABLE "C##MAASHESAPLA"."CALISANLAR" 
   (	"CALISANID" NUMBER, 
	"ADI" VARCHAR2(50), 
	"SOYADI" VARCHAR2(50), 
	"MAAS" NUMBER, 
	"DEPARTMANID" NUMBER, 
	 PRIMARY KEY ("CALISANID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS"  ENABLE
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;

ALTER TABLE "C##MAASHESAPLA"."CALISANLAR" ADD FOREIGN KEY ("DEPARTMANID")
	  REFERENCES "C##MAASHESAPLA"."DEPARTMANLAR" ("DEPARTMANID") ENABLE;

CREATE UNIQUE INDEX "C##MAASHESAPLA"."SYS_C008389" ON "C##MAASHESAPLA"."CALISANLAR" ("CALISANID") 
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;
;

CREATE TABLE "C##MAASHESAPLA"."DEPARTMANLAR" 
   (	"DEPARTMANID" NUMBER, 
	"DEPARTMANADI" VARCHAR2(50), 
	 PRIMARY KEY ("DEPARTMANID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS"  ENABLE
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;

CREATE UNIQUE INDEX "C##MAASHESAPLA"."SYS_C008388" ON "C##MAASHESAPLA"."DEPARTMANLAR" ("DEPARTMANID") 
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;
;

CREATE TABLE "C##MAASHESAPLA"."YENIMAASLAR" 
   (	"CALISANID" NUMBER, 
	"YENIMAAS" NUMBER, 
	"ESKIMAAS" NUMBER, 
	 PRIMARY KEY ("CALISANID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS"  ENABLE
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;

CREATE UNIQUE INDEX "C##MAASHESAPLA"."SYS_C008391" ON "C##MAASHESAPLA"."YENIMAASLAR" ("CALISANID") 
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;
;

CREATE OR REPLACE PROCEDURE "C##MAASHESAPLA".InsertEmployee(
    p_CalisanID NUMBER,
    p_Adi VARCHAR2,
    p_Soyadi VARCHAR2,
    p_Maas NUMBER,
    p_DepartmanID NUMBER
) AS
BEGIN
    -- Yeni çalışanı ekle
    INSERT INTO "C##MAASHESAPLA"."CALISANLAR" (CalisanID, ADI, SOYADI, Maas, DepartmanID)
    VALUES (p_CalisanID, p_Adi, p_Soyadi, p_Maas, p_DepartmanID);
    
    -- Maaş güncelleme prosedürünü çağır
    --UpdateEmployeeSalaries;

    DBMS_OUTPUT.PUT_LINE('Yeni çalışan eklendi ve maaş güncellemeleri yapıldı.');
END InsertEmployee;

CREATE OR REPLACE PROCEDURE "C##MAASHESAPLA".UpdateEmployeeSalaries AS
    
    CURSOR cur_Departmanlar IS 
        SELECT DepartmanID, DepartmanAdi 
        FROM Departmanlar;
    
    CURSOR cur_Calisanlar(p_DepartmanID NUMBER) IS 
        SELECT CalisanID, Maas 
        FROM Calisanlar 
        WHERE DepartmanID = p_DepartmanID;
    
    carpim_faktoru NUMBER;
BEGIN

    FOR departman IN cur_Departmanlar LOOP
        IF departman.DEPARTMANID = 1 THEN
            carpim_faktoru := 5;  
        ELSE
            carpim_faktoru := 3;  
        END IF;

        FOR calisan IN cur_Calisanlar(departman.DepartmanID) LOOP
            BEGIN
                -- Var olan kayıt varsa güncelle
                UPDATE YENIMAASLAR
                SET YENIMAAS = calisan.Maas * carpim_faktoru,
                    ESKIMAAS = calisan.Maas
                WHERE CALISANID = calisan.CalisanID;

                -- Eğer güncelleme yapılmadıysa, yeni kayıt ekle
                IF SQL%NOTFOUND THEN
                    INSERT INTO YENIMAASLAR (CALISANID, YENIMAAS, ESKIMAAS)
                    VALUES (calisan.CalisanID, calisan.Maas * carpim_faktoru, calisan.Maas);
                END IF;
            EXCEPTION
                WHEN OTHERS THEN
                    DBMS_OUTPUT.PUT_LINE('Hata: ' || SQLERRM);
            END;
        END LOOP;
    END LOOP;
    
    DBMS_OUTPUT.PUT_LINE('Tüm çalışan maaşları başarıyla güncellendi.');
END UpdateEmployeeSalaries;